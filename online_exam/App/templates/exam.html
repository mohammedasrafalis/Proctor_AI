{% extends 'home.html' %}
{% block content %}

<!-- ============================ STYLES ============================ -->
 <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to right, #1e3c72, #2a5298);
            background-size: cover;
            background-repeat: no-repeat;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: url('static/exam.jpg') center/cover no-repeat;
            filter: blur(8px) brightness(0.6);
            z-index: -1;
        }

        .contain {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 1200px;
            margin: 4% auto;
            padding: 20px;
            color: #fff;
            position: relative;
            transition: transform 0.3s ease;
        }

        .contain:hover {
            transform: scale(1.01);
        }

        .navbar {
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            animation: slideDown 0.5s ease;
        }

        .nav-link {
            color: #007bff !important;
            font-weight: 600;
            transition: color 0.3s ease, transform 0.3s ease;
        }

        .nav-link:hover {
            color: #0056b3 !important;
            transform: scale(1.1);
        }

        .question_base {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            padding: 30px;
            margin-top: 20px;
            color: white;
            animation: fadeIn 0.6s ease-in-out;
        }

        input[type="radio"], input[type="checkbox"] {
            margin: 10px;
            transform: scale(1.2);
            cursor: pointer;
        }

        label {
            cursor: pointer;
            display: block;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        label:hover {
            color: #ffcc70;
        }

        .btn {
            background: #00a8ff;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }

        .btn:hover {
            background: #0097e6;
            transform: translateY(-2px);
        }

        .sub {
            margin-top: 30px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media screen and (max-width: 768px) {
            .contain {
                width: 95%;
                padding: 15px;
            }

            .question_base {
                padding: 20px;
            }

            .exam-layout {
                flex-direction: column;
            }

            .exam-left, .exam-right {
                width: 100%;
            }
        }

        .exam-layout {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-top: 20px;
        }

        .exam-left, .exam-right {
            flex: 1;
        }

        video {
            max-width: 100%;
            border-radius: 12px;
            border: 2px solid white;
        }

        .important-notes {
            background: rgba(255, 69, 0, 0.85);
            color: #fff;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            margin: 40px auto 20px auto;
            font-weight: 600;
            box-shadow: 0 0 15px rgba(255, 69, 0, 0.7);
        }

        .important-notes h3 {
            margin-bottom: 10px;
            font-size: 1.5rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .important-notes ul {
            list-style-type: disc;
            padding-left: 20px;
            text-align: left;
        }

        .important-notes ul li {
            margin-bottom: 8px;
            font-size: 1rem;
        }
    </style>

<!-- ============================ FULL SCREEN ============================ -->

<script>
    function goFullScreen() {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.mozRequestFullScreen) { // Firefox
            elem.mozRequestFullScreen();
        } else if (elem.webkitRequestFullscreen) { // Chrome, Safari, Opera
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) { // IE/Edge
            elem.msRequestFullscreen();
        }
    }

    // Call fullscreen when the page loads or when a specific button is clicked
    window.onload = function () {
        goFullScreen();
    };
</script>

<!-- ============================ CONTENT ============================ -->
<div class="content">
    {% if code %}
       <div class="exam-right" style="text-align:center;">
    <img id="liveFeed" src="{% url 'App:procotor' %}" alt="Live Feed" style="max-width: 100%; border-radius: 12px; border: 2px solid white;">

</div>
        <style>
            .navbar {
                display: none;
            }
        </style>
        <div class="question_base">
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-danger" onclick="confirmExit()">Exit Exam</button>
            </div>

            <div class="question_1" id="1" style="display: none;">
                <p>{{ quest.question1 }}</p>
                <div class="options mb-5">
                    <div class="form-check mb-2">
                        <input type="radio" id="py" class="form-check-input" name="language1">
                        <label for="py" class="form-check-label">{{ quest.quest1_option1 }}</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="radio" id="html" class="form-check-input" name="language1">
                        <label for="html" class="form-check-label">{{ quest.quest1_option2 }}</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="radio" id="css" class="form-check-input" name="language1">
                        <label for="css" class="form-check-label">{{ quest.quest1_option3 }}</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="radio" id="js" class="form-check-input" name="language1">
                        <label for="js" class="form-check-label">{{ quest.quest1_option4 }}</label>
                    </div>
                </div>
                <div class="sub mt-5 d-flex justify-content-center align-items-center">
                    <button onclick="question2()" class="btn btn-primary">Submit</button>
                </div>
            </div>

            <div class="question_1" id="2" style="display: none;">
                <p>{{ quest.question2 }}</p>
                <div class="options mb-5">
                    <div class="form-check mb-2">
                        <input type="radio" class="form-check-input" name="language2">
                        <label class="form-check-label">{{ quest.quest2_option1 }}</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="radio" class="form-check-input" name="language2">
                        <label class="form-check-label">{{ quest.quest2_option2 }}</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="radio" class="form-check-input" name="language2">
                        <label class="form-check-label">{{ quest.quest2_option3 }}</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="radio" class="form-check-input" name="language2">
                        <label class="form-check-label">{{ quest.quest2_option4 }}</label>
                    </div>
                </div>
                <div class="sub mt-5 d-flex justify-content-center align-items-center">
                    <button onclick="question3()" class="btn btn-primary">Submit</button>
                </div>
            </div>

            <div class="question_1" id="3" style="display: none;">
                <p>{{ quest.question3 }}</p>
                <div class="options mb-5">
                    <div class="form-check mb-2">
                        <input type="radio" class="form-check-input" name="language3">
                        <label class="form-check-label">{{ quest.quest3_option1 }}</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="radio" class="form-check-input" name="language3">
                        <label class="form-check-label">{{ quest.quest3_option2 }}</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="radio" class="form-check-input" name="language3">
                        <label class="form-check-label">{{ quest.quest3_option3 }}</label>
                    </div>
                    <div class="form-check mb-2">
                        <input type="radio" class="form-check-input" name="language3">
                        <label class="form-check-label">{{ quest.quest3_option4 }}</label>
                    </div>
                </div>
                <div class="sub mt-5 d-flex justify-content-center align-items-center">
                    <button onclick="submitExam()" class="btn btn-primary">Submit</button>
                </div>
            </div>

        </div>

        <!-- Thank You Modal -->
        <div class="modal fade" id="thankYouModal" tabindex="-1" role="dialog" aria-labelledby="thankYouModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content text-dark">
                    <div class="modal-header">
                        <h5 class="modal-title" id="thankYouModalLabel">Thank You</h5>
                    </div>
                    <div class="modal-body">Your exam has been submitted successfully.</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="redirectToExit()">OK</button>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
<br><br><br><br><br><br>
     <div class="form-wrapper">
            <form method="POST">
                {% csrf_token %}
                <p>Enter Exam Code</p>
                <input type="number" name="code" id="code" autocomplete="off" required min="1" step="1" placeholder="Exam Code" />
                <button class="btn btn-primary" type="submit">Submit</button>
            </form>
        </div>

        <!-- Important Notes Before Entering Exam Code -->
        <div class="important-notes">
    <h3>Important Exam Rules</h3>
    <ul>
        <li>Please ensure you are not using a mobile device.</li>
        <li>Do not switch browser tabs or windows during the exam.</li>
        <li>Close all your tabs before starting.</li>
        <li>Full-screen mode is mandatory for the exam.</li>
        <li>Camera monitoring is active throughout the exam.</li>
        <li>Any violation may result in disqualification.</li>
        <li>Have a stable internet connection before proceeding.</li>
    </ul>
        <style>
            body {
                background: linear-gradient(to right, #74ebd5, #9face6);
                min-height: 100vh;
                margin: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }
            .form-wrapper {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 5%;
                width: 100%;
                position: relative;
                z-index: 1;
            }

            form {
                background-color: #ffffff;
                padding: 40px;
                border-radius: 15px;
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
                width: 350px;
                transition: transform 0.3s ease-in-out;
                text-align: center;
            }

            form:hover {
                transform: scale(1.02);
            }

            input[type="number"] {
                width: 100%;
                padding: 10px;
                margin-top: 10px;
                margin-bottom: 20px;
                border: 1px solid #ced4da;
                border-radius: 10px;
                transition: border-color 0.3s, box-shadow 0.3s;
            }

            p {
                font-size: 28px;
                margin-bottom: 20px;
                color: #333;
                animation: fadeIn 1s ease-in-out;
            }

            input[type="number"]:focus {
                border-color: #007bff;
                box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
                outline: none;
            }

            button {
                width: 100%;
                padding: 10px;
                border-radius: 10px;
                transition: background-color 0.3s, transform 0.2s;
            }

            button:hover {
                background-color: #0056b3;
                transform: translateY(-2px);
            }

            p {
                font-weight: 600;
                margin-bottom: 5px;
            }

            .navbar {
                background-color: rgba(255, 255, 255, 0.95);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                position: fixed;
                width: 100%;
                top: 0;
                left: 0;
                z-index: 999;
            }
        </style>

       
    {% endif %}
</div>

<!-- ============================ STRIKE MODAL ============================ -->
<div class="modal fade {{ model|default:'' }}" id="strikeModal" tabindex="-1" aria-labelledby="strikeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Strike Limit Exceeded</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">You have reached the maximum allowed strikes. Please exit the exam.</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="redirectToExit()">Exit Exam</button>
            </div>
        </div>
    </div>
</div>

<!-- ============================ SCRIPTS ============================ -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function confirmExit() {
        if (confirm("Are you sure you want to exit the exam? Your progress will not be saved.")) {
            redirectToExit();
        }
    }

    function redirectToExit() {
        window.location.href = "/exit_exam";
    }

    var question_1 = document.getElementById('1');
    var question_2 = document.getElementById('2');
    var question_3 = document.getElementById('3');

    function question2() {
        question_1.style.display = 'none';
        question_2.style.display = 'block';
    }

    function question3() {
        question_2.style.display = 'none';
        question_3.style.display = 'block';
    }

    function submitExam() {
        $('#thankYouModal').modal('show');
    }

    function checkImage() {
        var liveFeedImage = document.getElementById('liveFeed');
        if (liveFeedImage.complete) {
            question_1.style.display = 'block';
            clearInterval(intervalId);
        }
    }

    var intervalId = setInterval(checkImage, 1000);

    // Tab visibility detection
    document.addEventListener("visibilitychange", function () {
        if (document.hidden) {
            reportTabViolation();
        }
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    function reportTabViolation() {
        fetch('/api/tab_change', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ "tab": true })
        }).then(response => response.json())
          .then(data => console.log(data))
          .catch(error => console.error(error));
    }

    // Mobile detection
    function isMobileDevice() {
        return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    function reportMobileViolation() {
        fetch('/api/mobile_violation', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ violation: "Mobile device detected" })
        }).then(response => response.json())
          .then(data => {
              alert("Mobile devices are not allowed. You will be exited from the exam.");
              redirectToExit();
          })
          .catch(error => console.error('Mobile violation error:', error));
    }

    if (isMobileDevice()) {
        reportMobileViolation();
    }
</script>

{% endblock content %}
